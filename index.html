<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mapa Nelderim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'MedievalSharp', cursive;
      background: url('https://www.transparenttextures.com/patterns/old-map.png') repeat #0a0a0a;
      color: #f5f0e6;
      overflow: hidden;
      cursor: inherit;
    }
  
    #mainLayout {
      display: flex;
      flex-direction: row;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
  
    #controls {
      width: 300px;
      min-width: 36px; /* ‚Üê minimalna szeroko≈õƒá po zwiniƒôciu */
      height: 100%;
      overflow-y: auto;
      background: rgba(20, 20, 20, 0.95);
      color: #f5f0e6;
      padding: 12px;
      box-sizing: border-box;
      z-index: 1000;
      border-right: 1px solid #444;
      scrollbar-width: thin;
      scrollbar-color: #b08e53 rgba(40, 40, 40, 0.8);
      transition: width 0.4s ease, padding 0.4s ease;
      position: relative;
    }

    #controls.collapsed {
      width: 36px;
      padding: 12px 4px;
    }

    .hide-when-collapsed {
      transform: scaleY(1);
      transform-origin: top;
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
    }

  #controls.collapsed .hide-when-collapsed {
    transform: scaleY(0);
  }

  #controls.collapsed #sidebarToggle {
    right: 10px;
    left: auto;
    transform: none;
  }

    #controls label {
      display: flex;
      align-items: center;
      color: #f5f0e6;
      margin-bottom: 6px;
      font-size: 15px;
      gap: 6px;
    }
  
    #controls input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      background-image: url('Gump 5830.png');
      background-size: cover;
      border: none;
      outline: none;
      cursor: pointer;
    }
  
    #controls input[type="checkbox"]:checked {
      background-image: url('Gump 5828.png');
    }
  
    /* Styl suwaka (scrollbar) */
    #controls::-webkit-scrollbar {
      width: 8px;
    }
  
    #controls::-webkit-scrollbar-track {
      background: rgba(40, 40, 40, 0.8);
      border-radius: 4px;
    }
  
    #controls::-webkit-scrollbar-thumb {
      background: #b08e53;
      border: 1px solid #6d5635;
      border-radius: 4px;
    }
  
    #controls::-webkit-scrollbar-thumb:hover {
      background: #caa96d;
    }

    #sidebarToggle {
      width: 16px;
      height: 16px;
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-image: url('Gump 5603.png');
      cursor: pointer;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 1001;
    }

    #sidebarToggle.collapsed {
      background-image: url('Gump 5601.png'); /* rozwijanie (‚Üí) */
    }

    #map {
      flex: 1;
      height: 100%;
      min-width: 0;
      transition: margin-left 0.4s ease; /* dla p≈Çynno≈õci */
    }

    #coordsDisplay {
      background: rgba(40, 40, 40, 0.95);
      color: #f5f0e6;
      padding: 6px 10px;
      font-size: 14px;
      font-family: 'MedievalSharp', cursive;
      border: 1px solid #444;
      border-radius: 5px;
      margin-top: 10px;
      margin-bottom: 10px;
      text-align: center;
    }

    .coords-inline {
      display: flex;
      justify-content: center;
      gap: 12px; /*odstƒôp miƒôdzy X a Y w Menu*/ 
    }

    #coordsDisplay span {
      font-size: 14px;
    }

    .subgroup {
      height: 0;
      overflow: hidden;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
      margin-left: 24px;
      margin-top: 0;
      transition:
        height 1.0s ease,
        padding 1.0s ease,
        opacity 0.8s ease,
        margin-top 0.8s ease;
      }

    .subgroup.expand {
      height: auto;
      opacity: 1;
      padding-top: 4px;
      padding-bottom: 4px;
      margin-top: 4px;
    }

    .subgroup.collapse {
      height: 0;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
      margin-top: 0;
    }
  
    .toggle-button {
      width: 16px;
      height: 16px;
      min-width: 16px;
      background-image: url('Gump 5602.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      cursor: pointer;
      display: inline-block;
      margin-left: 8px;
      transition: filter 0.2s ease, transform 0.3s ease; /* p≈Çynna animacja */
    }

    .toggle-button.open {
      background-image: url('Gump 5600.png');
      transform: rotate(90deg);
    }

    .toggle-button:hover {
      animation: pulse-glow 1.2s infinite ease-in-out;
    }

    .toggle-button:active {
      transform: scale(0.95) rotate(90deg); /* skalowanie + obr√≥t */
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
  
    .control-row .left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
  
    @keyframes popupFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.7);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
  
    .leaflet-popup-content-wrapper {
      background: none;
      background-image: url('Gump 1588.png');
      background-repeat: repeat;
      background-size: 100% 100%;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
      border: none;
      min-height: 25px;
      animation: popupFadeIn 0.35s ease-out;
      transform-origin: top center;
    }
  
    .leaflet-popup-content {
      margin: 2px;
      padding: 10px 15px;
      font-family: 'MedievalSharp', cursive;
      font-size: 15px;
      color: #000000;
      line-height: 25px;
      display: inline-block;
      white-space: normal;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
  
    .leaflet-popup-tip {
      display: none;
    }
  
    .leaflet-popup-content-wrapper,
    .leaflet-popup {
      width: auto !important;
      max-width: none !important;
    }

    #logoContainer {
      text-align: center;
      margin-bottom: 14px;
    }

    #logoContainer img {
      max-width: 90%;
      height: auto;
      filter: drop-shadow(0 0 6px #010200);
    }

    .leaflet-control-zoom {
      background: rgba(20, 20, 20, 0.95) !important;
      border: 1px solid #444 !important;
      box-shadow: 0 0 6px rgba(0,0,0,0.6);
      border-radius: 6px;
    }

    .leaflet-control-zoom a {
      color: #f5f0e6 !important;
      font-weight: bold;
      background-color: transparent !important;
      text-decoration: none;
      font-size: 18px;
    }

    .leaflet-control-zoom a:hover {
      background-color: #333 !important;
    }

    #zoomControl {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }

    #zoomControl button {
      flex: 1;
      background-color: #1e1e1e;
      color: #f5f0e6;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 6px 0;
      font-size: 18px;
      cursor: pointer;
    }

    #zoomControl button:hover {
      background-color: #b08e53;
      color: #000;
    }

    /* Efekt po≈õwiaty dla wszystkich aktywnych element√≥w */
    button,
    input[type="button"],
    input[type="checkbox"],
    #sidebarToggle,
    #zoomIn,
    #zoomOut,
    #searchInput,
    details summary {
      transition: filter 0.2s ease;
    }

    /* Efekt wci≈õniƒôcia (klikniƒôcia) */
    button:active,
    input[type="button"]:active,
    input[type="checkbox"]:active,
    #sidebarToggle:active,
    #zoomIn:active,
    #zoomOut:active,
    #searchInput:active,
    details summary:active {
      transform: scale(0.95);
      transition: transform 0.05s ease;
    }

    /* Hover ‚Äì z≈Çota po≈õwiata */
    button:hover,
    input[type="button"]:hover,
    input[type="checkbox"]:hover,
    #sidebarToggle:hover,
    #zoomIn:hover,
    #zoomOut:hover,
    #searchInput:hover,
    details summary:hover {
      animation: pulse-glow 1.2s infinite ease-in-out;
    }

    @keyframes pulse-glow {
  0% {
    filter: drop-shadow(0 0 4px #b08e53);
  }
  50% {
    filter: drop-shadow(0 0 8px #b08e53);
  }
  100% {
    filter: drop-shadow(0 0 4px #b08e53);
  }
}

#logoContainer a img {
  transition: filter 0.4s ease;
}

#logoContainer a:hover img {
  filter: drop-shadow(0 0 8px #b08e53);
  cursor: pointer;
}

.leaflet-container {
  background-color: #0a0a0a !important;
  cursor: inherit !important;
}

*{
  cursor: inherit !important;
}

#searchBox,
input[type="text"],
textarea {
  cursor: url('text-cursor.png') 10 16, text !important;
}


  </style>
</head>
<body>
  <!-- Kontrolki, mapa i wsp√≥≈Çrzƒôdne -->
<div id="mainLayout">
  <div id="controls">
  
    <div class="hide-when-collapsed">
      <div id="logoContainer">
        <a href="https://nelderim.pl" target="_blank">
          <img src="logotyp-new.png" alt="Nelderim logo">
        </a>
      </div>
      
      <div id="searchWrapper" style="position: relative; margin-bottom: 12px;">
        <input type="text" id="searchBox" placeholder="Szukaj..." style="
          box-sizing: border-box;
          width: 100%;
          padding: 6px 32px 6px 8px;
          font-family: 'MedievalSharp', cursive;
          font-size: 14px;
          border: 1px solid #444;
          border-radius: 4px;
          background: #1e1e1e;
          color: #f5f0e6;
        ">
        <span style="
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          pointer-events: none;
          font-size: 16px;
          color: #b08e53;  
        ">üîç</span>
      </div>

      <div class="control-row">
        <div class="left">
          <input type="checkbox" id="toggleCitiesGroup">
          <span>Miasta</span>
        </div>
        <div id="toggleCitiesBtn" class="toggle-button"></div>
      </div>
      <div id="citiesSubgroup" class="subgroup"></div>

      <div class="control-row">
        <div class="left">
          <input type="checkbox" id="toggleVillagesGroup">
          <span>Wioski</span>
        </div>
        <div id="toggleVillagesBtn" class="toggle-button"></div>
      </div>
      <div id="villagesSubgroup" class="subgroup"></div>

      <div class="control-row">
        <div class="left">
          <input type="checkbox" id="toggleDungeonsGroup">
          <span>Lochy</span>
        </div>
        <div id="toggleDungeonsBtn" class="toggle-button"></div>
      </div>
      <div id="dungeonsSubgroup" class="subgroup"></div>

      <div class="control-row">
        <div class="left">
          <input type="checkbox" id="toggleHealersGroup">
          <span>Uzdrowiciele</span>
        </div>
        <div id="toggleHealersBtn" class="toggle-button"></div>
      </div>
      <div id="healersSubgroup" class="subgroup"></div>

      <div class="control-row">
        <div class="left">
          <input type="checkbox" id="toggleAnkhGroup">
          <span>Ankh</span>
        </div>
        <div id="toggleAnkhBtn" class="toggle-button"></div>
      </div>
      <div id="ankhSubgroup" class="subgroup"></div>

      <div id="coordsDisplay">
        <div class="coords-inline">
          <span class="coord-x">X: 0</span>
          <span class="coord-y">Y: 0</span>
        </div>
      </div>
      <div id="zoomControl">
        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
      </div>
    </div>

    <div id="sidebarToggle" title="Zwi≈Ñ / Rozwi≈Ñ"></div>

  </div>
  <div id="map"></div>
</div>


<script>
const mapWidth = 7168;
const mapHeight = 4096;
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -3.5,
  maxZoom: 2,
  zoomSnap: 0.1,
  zoomDelta: 0.1,
  zoom: -2,
  zoomControl: false // tylko to dodajemy
});

const bounds = [[0, 0], [mapHeight, mapWidth]];
L.imageOverlay('mapa_serwera.png', bounds).addTo(map);
map.fitBounds(bounds);

const toggleGroup = (btnId, subgroupId, open) => {
  const btn = document.getElementById(btnId);
  const group = document.getElementById(subgroupId);

  btn.classList.toggle('open', open);
  group.style.overflow = 'hidden';
  group.style.transition = open
    ? 'height 1.0s ease, padding 1.0s ease, opacity 0.8s ease, margin-top 0.8s ease'
    : 'height 0.6s ease, padding 0.6s ease, opacity 0.4s ease, margin-top 0.4s ease';

  if (open) {
    group.style.height = group.scrollHeight + 'px';
    group.style.opacity = '1';
    group.style.paddingTop = '4px';
    group.style.paddingBottom = '4px';
    group.style.marginTop = '4px';

    group.addEventListener('transitionend', function handler(e) {
      if (e.propertyName === 'height') {
        group.style.height = 'auto';
        group.removeEventListener('transitionend', handler);
      }
    });
  } else {
    group.style.height = group.scrollHeight + 'px';
    requestAnimationFrame(() => {
      group.style.height = '0';
      group.style.opacity = '0';
      group.style.paddingTop = '0';
      group.style.paddingBottom = '0';
      group.style.marginTop = '0';
    });
  }
};

const cityIcon = L.icon({ iconUrl: 'Gump 30564.png', iconSize: [32, 32], iconAnchor: [16, 16] });
const dungeonIcon = L.icon({ iconUrl: 'Gump 9804.png', iconSize: [32, 32], iconAnchor: [16, 16] });
const villageIcon = L.icon({ iconUrl: 'Gump 30565.png', iconSize: [28, 28], iconAnchor: [14, 14] });
const healerIcon = L.icon({ iconUrl: 'Gump 30560.png', iconSize: [24, 24], iconAnchor: [12, 12] });
const ankhIcon = L.icon({ iconUrl: 'Gump 30561.png', iconSize: [24, 24], iconAnchor: [12, 12] });

const cityData = {
  tasandora: [1418, 1872, "Tasandora"],
  garlan:    [1058, 592, "Garlan"],
  orod:      [658, 2009, "Orod"],
  lotharn:   [1875, 503, "Lotharn"],
  ldelmah:   [5742, 3307, "L'Delmah"],
  twierdza:  [2550, 1771, "Twierdza"],
  tirassa:   [2067, 2699, "Tirassa"]
};

const cityMarkers = {};
const citiesSubgroup = document.getElementById("citiesSubgroup");


const dungeonData = {
  alcala: [819, 232, "Alcala"],
  baradDur: [960, 465, "Barad-dur"],
  doom: [400, 319, "Doom"],
  elghinn: [288, 1973, "Elghinn"],
  garth: [397, 390, "Garth"],
  hallTorech: [699, 1207, "Hall Torech"],
  hurengrav: [457, 337, "Hurengrav"],
  jaskiniaBlyskow: [711, 1131, "Jaskinia B≈Çysk√≥w"],
  kanalyTasandory: [697, 439, "Kana≈Çy Tasandory"],
  krolewskieKrypty: [1171, 275, "Kr√≥lewskie Krypty"],
  krysztalowaJaskinia: [762, 1279, "Kryszta≈Çowa Jaskinia"],
  labirynt: [710, 930, "Labirynt"],
  lezeKrysztalowychSmokow: [960, 124, "Le≈ºe Kryszta≈Çowych Smok√≥w"],
  lezeLodowychSmokow: [1062, 133, "Le≈ºe Lodowych Smok√≥w"],
  lezeOgnistychSmokow: [738, 952, "Le≈ºe Ognistych Smok√≥w"],
  lezePluskwy: [597, 1315, "Le≈ºe Pluskwy"],
  lezeTrolli: [884, 142, "Le≈ºe Trolli"],
  lochBagusa: [957, 228, "Loch Bagusa"],
  lochOphidian: [209, 685, "Loch Ophidian"],
  loenTorech: [820, 1138, "Loen Torech"],
  mechanicznaKrypta: [401, 825, "Mechaniczna Krypta"],
  piramida: [568, 803, "Piramida"],
  piaskoweKrypty: [396, 817, "Piaskowe Krypty"],
  podziemiaSaew: [1149, 455, "Podziemia Saew"],
  podziemiaSwiatyniSmierci: [764, 424, "Podziemia ≈öwiƒÖtyni ≈ömierci"],
  pokracznyLoch: [1019, 1324, "Pokraczny Loch"],
  ruinyElbrind: [1087, 508, "Ruiny Elbrind"],
  saleParoxysmusa: [554, 2019, "Sale Paroxysmusa"],
  siedliskoDemonow: [821, 1280, "Siedziba Demon√≥w"],
  tylReviaren: [533, 464, "Tyl Reviaren"],
  twierdzaZwiednietejRozy: [816, 714, "Twierdza Zwiƒôdniƒôtej R√≥≈ºy"],
  ulnhyrOrbben: [456, 521, "Ulnhyr Orbben"],
  velkynAto: [110, 1813, "Velkyn Ato"],
  wulkan: [935, 194, "Wulkan"]
};

const customDungeons = {};
const dungeonsSubgroup = document.getElementById("dungeonsSubgroup");

const villageData = {
  celendir: [2016, 2035, "Celendir"],
  ethrod: [808, 1520, "Ethrod"],
  talas: [1158, 1603, "Talas"],
  ferion: [999, 1144, "Ferion"],
  kryjowkaPrzemytnikow: [2085, 3377, "Kryj√≥wka Przemytnik√≥w"],
  noamuthQuortek: [5941, 2757, "Noamuth Quortek"],
  oaza: [2312, 2559, "Oaza"],
  podzamcze: [1472, 2125, "Podzamcze"],
  snieznaPrzystan: [992, 909, "≈önie≈ºna Przysta≈Ñ"],
  tafroel: [965, 1424, "Tafroel"],
  tingref: [695, 1808, "Tingref"],
  uk: [243, 1458, "Uk"]
};

const customVillages = {};
const villagesSubgroup = document.getElementById("villagesSubgroup");

const healerData = {
  tasandoraHeal: [740, 480, "Uzdrowiciel ‚Äì Tasandora"],
  tirassaHeal: [470, 685, "Uzdrowiciel ‚Äì Tirassa"]
};
const customHealers = {};
const healersSubgroup = document.getElementById("healersSubgroup");

const ankhData = {
  orodAnkh: [690, 230, "Ankh ‚Äì Orod"],
  garlanAnkh: [1170, 360, "Ankh ‚Äì Garlan"]
};

const customAnkh = {};
const ankhSubgroup = document.getElementById("ankhSubgroup");



Object.entries(cityData).sort((a, b) => a[1][2].localeCompare(b[1][2])).forEach(([id, [x, y, name]]) => {
  const marker = L.marker([mapHeight - y, x],
 { icon: cityIcon }).bindPopup(name);
  cityMarkers[id] = marker;

  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="city-toggle" data-id="${id}"> ${name}`;
  citiesSubgroup.appendChild(label);
});


Object.entries(dungeonData).sort((a, b) => a[1][2].localeCompare(b[1][2])).forEach(([id, [x, y, name]]) => {
  const marker = L.marker([mapHeight - y, x], { icon: dungeonIcon }).bindPopup(name);
  customDungeons[id] = marker;
  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="dungeon-toggle" data-id="${id}"> ${name}`;
  dungeonsSubgroup.appendChild(label);
});


Object.entries(villageData).sort((a, b) => a[1][2].localeCompare(b[1][2])).forEach(([id, [x, y, name]]) => {
  const marker = L.marker([mapHeight - y, x], { icon: villageIcon }).bindPopup(name);
  customVillages[id] = marker;

  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="village-toggle" data-id="${id}"> ${name}`;
  villagesSubgroup.appendChild(label);
});

Object.entries(healerData).sort((a, b) => a[1][2].localeCompare(b[1][2])).forEach(([id, [x, y, name]]) => {
  const marker = L.marker([mapHeight - y, x], { icon: healerIcon }).bindPopup(name);
  customHealers[id] = marker;

  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="healer-toggle" data-id="${id}"> ${name}`;
  healersSubgroup.appendChild(label);
});

Object.entries(ankhData).sort((a, b) => a[1][2].localeCompare(b[1][2])).forEach(([id, [x, y, name]]) => {
  const marker = L.marker([mapHeight - y, x], { icon: ankhIcon }).bindPopup(name);
  customAnkh[id] = marker;

  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="ankh-toggle" data-id="${id}"> ${name}`;
  ankhSubgroup.appendChild(label);
});

document.querySelectorAll('.city-toggle').forEach(cb => {
  cb.addEventListener('change', e => {
    const id = e.target.dataset.id;
    if (e.target.checked) cityMarkers[id].addTo(map);
    else map.removeLayer(cityMarkers[id]);
  });
});

document.querySelectorAll('.dungeon-toggle').forEach(cb => {
  cb.addEventListener('change', e => {
    const id = e.target.dataset.id;
    if (e.target.checked) customDungeons[id].addTo(map);
    else map.removeLayer(customDungeons[id]);
  });
});

document.querySelectorAll('.village-toggle').forEach(cb => {
  cb.addEventListener('change', e => {
    const id = e.target.dataset.id;
    if (e.target.checked) customVillages[id].addTo(map);
    else map.removeLayer(customVillages[id]);
  });
});

document.querySelectorAll('.healer-toggle').forEach(cb => {
  cb.addEventListener('change', e => {
    const id = e.target.dataset.id;
    if (e.target.checked) customHealers[id].addTo(map);
    else map.removeLayer(customHealers[id]);
  });
});

document.querySelectorAll('.ankh-toggle').forEach(cb => {
  cb.addEventListener('change', e => {
    const id = e.target.dataset.id;
    if (e.target.checked) customAnkh[id].addTo(map);
    else map.removeLayer(customAnkh[id]);
  });
});

document.getElementById('toggleCitiesBtn').addEventListener('click', () => {
  const btn = document.getElementById('toggleCitiesBtn');
  const group = document.getElementById('citiesSubgroup');
  btn.classList.toggle('open');
  const isNowOpen = btn.classList.contains('open');

  // Usu≈Ñ height: auto, je≈õli by≈Ço
  group.style.height = getComputedStyle(group).height;
  group.style.overflow = 'hidden';

  if (isNowOpen) {
    group.style.transition = `
      height 1.0s ease,
      padding 1.0s ease,
      opacity 0.8s ease,
      margin-top 0.8s ease
    `;
    group.style.opacity = '1';
    group.style.paddingTop = '4px';
    group.style.paddingBottom = '4px';
    group.style.marginTop = '4px';
    group.style.height = group.scrollHeight + 'px';

    group.addEventListener('transitionend', function handler(e) {
      if (e.propertyName === 'height') {
        group.style.height = 'auto';
        group.removeEventListener('transitionend', handler);
      }
    });
  } else {
    group.style.transition = `
      height 0.7s ease,
      padding 0.7s ease,
      opacity 0.4s ease,
      margin-top 0.4s ease
    `;
    group.style.height = group.scrollHeight + 'px';
    requestAnimationFrame(() => {
      group.style.height = '0';
      group.style.opacity = '0';
      group.style.paddingTop = '0';
      group.style.paddingBottom = '0';
      group.style.marginTop = '0';
    });
  }
});

document.getElementById('toggleDungeonsBtn').addEventListener('click', () => {
  const btn = document.getElementById('toggleDungeonsBtn');
  const group = document.getElementById('dungeonsSubgroup');
  btn.classList.toggle('open');
  const isNowOpen = btn.classList.contains('open');

  // Zablokuj auto-height i ustaw overflow
  group.style.height = getComputedStyle(group).height;
  group.style.overflow = 'hidden';

  if (isNowOpen) {
    group.style.transition = `
      height 1.0s ease,
      padding 1.0s ease,
      opacity 0.8s ease,
      margin-top 0.8s ease
    `;
    group.style.opacity = '1';
    group.style.paddingTop = '4px';
    group.style.paddingBottom = '4px';
    group.style.marginTop = '4px';
    group.style.height = group.scrollHeight + 'px';

    group.addEventListener('transitionend', function handler(e) {
      if (e.propertyName === 'height') {
        group.style.height = 'auto';
        group.removeEventListener('transitionend', handler);
      }
    });
  } else {
    group.style.transition = `
      height 0.7s ease,
      padding 0.7s ease,
      opacity 0.4s ease,
      margin-top 0.4s ease
    `;
    group.style.height = group.scrollHeight + 'px';
    requestAnimationFrame(() => {
      group.style.height = '0';
      group.style.opacity = '0';
      group.style.paddingTop = '0';
      group.style.paddingBottom = '0';
      group.style.marginTop = '0';
    });
  }
});

document.getElementById('toggleVillagesBtn').addEventListener('click', () => {
  const btn = document.getElementById('toggleVillagesBtn');
  const group = document.getElementById('villagesSubgroup');
  btn.classList.toggle('open');
  const isNowOpen = btn.classList.contains('open');

  // Usu≈Ñ auto height i ustaw overflow
  group.style.height = getComputedStyle(group).height;
  group.style.overflow = 'hidden';

  if (isNowOpen) {
    group.style.transition = `
      height 1.0s ease,
      padding 1.0s ease,
      opacity 0.8s ease,
      margin-top 0.8s ease
    `;
    group.style.opacity = '1';
    group.style.paddingTop = '4px';
    group.style.paddingBottom = '4px';
    group.style.marginTop = '4px';
    group.style.height = group.scrollHeight + 'px';

    group.addEventListener('transitionend', function handler(e) {
      if (e.propertyName === 'height') {
        group.style.height = 'auto';
        group.removeEventListener('transitionend', handler);
      }
    });
  } else {
    group.style.transition = `
      height 0.7s ease,
      padding 0.7s ease,
      opacity 0.4s ease,
      margin-top 0.4s ease
    `;
    group.style.height = group.scrollHeight + 'px';
    requestAnimationFrame(() => {
      group.style.height = '0';
      group.style.opacity = '0';
      group.style.paddingTop = '0';
      group.style.paddingBottom = '0';
      group.style.marginTop = '0';
    });
  }
});

document.getElementById('toggleHealersBtn').addEventListener('click', () => {
  const btn = document.getElementById('toggleHealersBtn');
  const group = document.getElementById('healersSubgroup');
  btn.classList.toggle('open');
  const isNowOpen = btn.classList.contains('open');

  // Zablokuj auto height
  group.style.height = getComputedStyle(group).height;
  group.style.overflow = 'hidden';

  if (isNowOpen) {
    group.style.transition = `
      height 1.0s ease,
      padding 1.0s ease,
      opacity 0.8s ease,
      margin-top 0.8s ease
    `;
    group.style.opacity = '1';
    group.style.paddingTop = '4px';
    group.style.paddingBottom = '4px';
    group.style.marginTop = '4px';
    group.style.height = group.scrollHeight + 'px';

    group.addEventListener('transitionend', function handler(e) {
      if (e.propertyName === 'height') {
        group.style.height = 'auto';
        group.removeEventListener('transitionend', handler);
      }
    });
  } else {
    group.style.transition = `
      height 0.7s ease,
      padding 0.7s ease,
      opacity 0.4s ease,
      margin-top 0.4s ease
    `;
    group.style.height = group.scrollHeight + 'px';
    requestAnimationFrame(() => {
      group.style.height = '0';
      group.style.opacity = '0';
      group.style.paddingTop = '0';
      group.style.paddingBottom = '0';
      group.style.marginTop = '0';
    });
  }
});

document.getElementById('toggleAnkhBtn').addEventListener('click', () => {
  const btn = document.getElementById('toggleAnkhBtn');
  const group = document.getElementById('ankhSubgroup');
  btn.classList.toggle('open');
  const isNowOpen = btn.classList.contains('open');

  // Zablokuj auto height
  group.style.height = getComputedStyle(group).height;
  group.style.overflow = 'hidden';

  if (isNowOpen) {
    group.style.transition = `
      height 1.0s ease,
      padding 1.0s ease,
      opacity 0.8s ease,
      margin-top 0.8s ease
    `;
    group.style.opacity = '1';
    group.style.paddingTop = '4px';
    group.style.paddingBottom = '4px';
    group.style.marginTop = '4px';
    group.style.height = group.scrollHeight + 'px';

    group.addEventListener('transitionend', function handler(e) {
      if (e.propertyName === 'height') {
        group.style.height = 'auto';
        group.removeEventListener('transitionend', handler);
      }
    });
  } else {
    group.style.transition = `
      height 0.7s ease,
      padding 0.7s ease,
      opacity 0.4s ease,
      margin-top 0.4s ease
    `;
    group.style.height = group.scrollHeight + 'px';
    requestAnimationFrame(() => {
      group.style.height = '0';
      group.style.opacity = '0';
      group.style.paddingTop = '0';
      group.style.paddingBottom = '0';
      group.style.marginTop = '0';
    });
  }
});

document.getElementById('toggleCitiesGroup').addEventListener('change', e => {
  const checked = e.target.checked;
  document.querySelectorAll('.city-toggle').forEach(cb => {
    cb.checked = checked;
    cb.dispatchEvent(new Event('change'));
  });
});

document.getElementById('toggleDungeonsGroup').addEventListener('change', e => {
  const checked = e.target.checked;
  document.querySelectorAll('.dungeon-toggle').forEach(cb => {
    cb.checked = checked;
    cb.dispatchEvent(new Event('change'));
  });
});

document.getElementById('toggleVillagesGroup').addEventListener('change', e => {
  const checked = e.target.checked;
  document.querySelectorAll('.village-toggle').forEach(cb => {
    cb.checked = checked;
    cb.dispatchEvent(new Event('change'));
  });
});

document.getElementById('toggleHealersGroup').addEventListener('change', e => {
  const checked = e.target.checked;
  document.querySelectorAll('.healer-toggle').forEach(cb => {
    cb.checked = checked;
    cb.dispatchEvent(new Event('change'));
  });
});

document.getElementById('toggleAnkhGroup').addEventListener('change', e => {
  const checked = e.target.checked;
  document.querySelectorAll('.ankh-toggle').forEach(cb => {
    cb.checked = checked;
    cb.dispatchEvent(new Event('change'));
  });
});

map.on('mousemove', e => {
  const x = Math.round(e.latlng.lng);
  const y = Math.round(mapHeight - e.latlng.lat);
  document.getElementById('coordsDisplay').innerHTML = `
  <div class="coords-inline">
    <span class="coord-x">X: ${x}</span>
    <span class="coord-y">Y: ${y}</span>
  </div>
`;
});


// Zapamiƒôtywanie stanu checkbox√≥w
const saveState = () => {
  const states = {};
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    states[cb.dataset.id || cb.id] = cb.checked;
  });
  localStorage.setItem('checkboxStates', JSON.stringify(states));
};

const loadState = () => {
  const saved = JSON.parse(localStorage.getItem('checkboxStates') || '{}');
  Object.entries(saved).forEach(([key, value]) => {
    const el = document.querySelector(`[data-id="${key}"], #${key}`);
    if (el) {
      el.checked = value;
      el.dispatchEvent(new Event('change'));
    }
  });
};

window.addEventListener('load', () => {
  loadState();
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', saveState);
  });

});

window.addEventListener('DOMContentLoaded', () => {
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');

  if (zoomInBtn && zoomOutBtn) {
    zoomInBtn.addEventListener('click', () => map.zoomIn());
    zoomOutBtn.addEventListener('click', () => map.zoomOut());
  }
});

const allSubgroups = [
  { btn: 'toggleCitiesBtn', group: 'citiesSubgroup' },
  { btn: 'toggleVillagesBtn', group: 'villagesSubgroup' },
  { btn: 'toggleDungeonsBtn', group: 'dungeonsSubgroup' },
  { btn: 'toggleHealersBtn', group: 'healersSubgroup' },
  { btn: 'toggleAnkhBtn', group: 'ankhSubgroup' }
];

//Wyszukiwarka
document.getElementById('searchBox').addEventListener('input', function () {
  const query = this.value.toLowerCase();

  if (query === '') {
    // 1. Poka≈º wszystkie etykiety
    document.querySelectorAll('#controls label').forEach(label => {
      label.style.display = 'flex';
    });

    // 2. ZWI≈É wszystkie grupy na sztywno
    allSubgroups.forEach(({ btn, group }) => {
      const btnEl = document.getElementById(btn);
      const groupEl = document.getElementById(group);

      // Wymuszone zwiniƒôcie grupy ‚Äì bez animacji
      btnEl.classList.remove('open');
      groupEl.style.transition = 'none'; // usu≈Ñ animacjƒô
      groupEl.style.height = '0';
      groupEl.style.opacity = '0';
      groupEl.style.paddingTop = '0';
      groupEl.style.paddingBottom = '0';
      groupEl.style.marginTop = '0';
      groupEl.style.overflow = 'hidden';
    });

    return;
  }

  // FILTROWANIE wynik√≥w
  document.querySelectorAll('#controls label').forEach(label => {
    const text = label.textContent.toLowerCase();
    label.style.display = text.includes(query) ? 'flex' : 'none';
  });

  // ROZWI≈É tylko grupy z wynikami
  allSubgroups.forEach(({ btn, group }) => {
    const groupEl = document.getElementById(group);
    const visibleLabels = [...groupEl.querySelectorAll('label')].filter(label =>
      window.getComputedStyle(label).display !== 'none'
    );

    const shouldExpand = visibleLabels.length > 0;
    toggleGroup(btn, group, shouldExpand);
    document.getElementById(btn).classList.toggle('open', shouldExpand);
  });
});


//Sidebar
const sidebar = document.getElementById('controls');
const toggleBtn = document.getElementById('sidebarToggle');

// Przywr√≥ƒá stan zapisany wcze≈õniej
if (localStorage.getItem('sidebarCollapsed') === 'true') {
  sidebar.classList.add('collapsed');
  toggleBtn.classList.add('collapsed');
}

// Obs≈Çuga klikniƒôcia
toggleBtn.addEventListener('click', () => {
  const collapsed = sidebar.classList.toggle('collapsed');
  toggleBtn.classList.toggle('collapsed', collapsed);
  localStorage.setItem('sidebarCollapsed', collapsed);
  setTimeout(() => map.invalidateSize(), 400);
});

</script>

<script>


  const cursors = {
    n:  { file: 'glove-n.png',  hotspot: [16, 4] },
    ne: { file: 'glove-ne.png', hotspot: [25, 8] },
    e:  { file: 'glove-e.png',  hotspot: [35, 14] },
    se: { file: 'glove-se.png', hotspot: [25, 25] },
    s:  { file: 'glove-s.png',  hotspot: [16, 30] },
    sw: { file: 'glove-sw.png', hotspot: [6, 25] },
    w:  { file: 'glove-w.png',  hotspot: [4, 14] },
    nw: { file: 'glove-nw.png', hotspot: [6, 8] }
  };

  const clickStages = [
    { file: 'click1st_stage.png', hotspot: [16, 16] },
    { file: 'click2nd_stage.png', hotspot: [16, 16] }
  ];

  let currentDirection = 'e';
  let clickTimeout;

  document.addEventListener('mousemove', (e) => {
  if (clickTimeout) return;

  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  const dx = e.clientX - centerX;
  const dy = e.clientY - centerY;
  const angle = Math.atan2(dy, dx) * (180 / Math.PI);

  let dir = 'e';
  if (angle >= -22.5 && angle < 22.5) dir = 'e';
  else if (angle >= 22.5 && angle < 67.5) dir = 'se';
  else if (angle >= 67.5 && angle < 112.5) dir = 's';
  else if (angle >= 112.5 && angle < 157.5) dir = 'sw';
  else if (angle >= 157.5 || angle < -157.5) dir = 'w';
  else if (angle >= -157.5 && angle < -112.5) dir = 'nw';
  else if (angle >= -112.5 && angle < -67.5) dir = 'n';
  else if (angle >= -67.5 && angle < -22.5) dir = 'ne';

  if (dir !== currentDirection) {
    currentDirection = dir;
    const { file, hotspot } = cursors[dir];
    document.body.style.cursor = `url(${file}) ${hotspot[0]} ${hotspot[1]}, auto`;
  }
});


  document.addEventListener('mousedown', () => {
    if (clickTimeout) clearTimeout(clickTimeout);

    const stage1 = clickStages[0];
    document.body.style.cursor = `url(${stage1.file}) ${stage1.hotspot[0]} ${stage1.hotspot[1]}, auto`;

    clickTimeout = setTimeout(() => {
      const stage2 = clickStages[1];
      document.body.style.cursor = `url(${stage2.file}) ${stage2.hotspot[0]} ${stage2.hotspot[1]}, auto`;
    }, 100);
  });

  document.addEventListener('mouseup', () => {
    clearTimeout(clickTimeout);
    clickTimeout = null;

    const { file, hotspot } = cursors[currentDirection];
    document.body.style.cursor = `url(${file}) ${hotspot[0]} ${hotspot[1]}, auto`;
  });
</script>

</body>
</html>
